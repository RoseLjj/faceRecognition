<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>“父爱如山”点赞活动</title>
    <meta name="description" content="双节同庆领双份万元旅行大奖，送父亲一场难忘的旅行！"/>
    <meta name="keywords" content="你是我见过最美的一座山"/>

    <link rel="stylesheet" href="css/common.css"/>

    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="js/jquery-1.11.0.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.js"></script>
    <script src="js/jquery.facedetection.js"></script>
    <style>
        #img{
            width: 300px;
        }
    </style>
</head>
<body>

<input onchange="uploadImg(this)" type="file" name="" id="uploadImg" accept="image/*">
<div class="demo-container"><img class="fa-img" id="img" src="../../img/active/dragonBoat/zp.jpg" imgUrl="" alt=""></div>

</body>
</html>
<script>
	
    /**
     * 上传图片
     * @param that
     */
    function uploadImg(that) {
        var file = that.files[0];
        var r = new FileReader();
        r.readAsDataURL(file);
        $(r).load(function () {
            $('.demo-container').html('<img class="fa-img" id="img" src="'+ this.result+'" imgUrl="" alt="">');
            $('#img').load(function () {
//                trackerFace()
                tryIt()
            })
        })
    }

    var takePicture = document.getElementById('uploadImg');
    var takePictureUrl = function () {
        takePicture.onchange = function (event) {
            var files = event.target.files, file;
            if (files && files.length > 0) {
                file = files[0];
                try {
                    var URL = window.URL || window.webkitURL;
                    var blob = URL.createObjectURL(file);　　// 获取照片的文件流
                    compressPicture(blob);　　// 压缩照片
                }
                catch (e) {
                    try {
                        var fileReader = new FileReader();
                        fileReader.onload = function (event) {　　　　// 获取照片的base64编码
                            compressPicture(event.target.result);　　// 压缩照片
                        };
                        fileReader.readAsDataURL(file);
                    }
                    catch (e) {
                        alert(common.MESSAGE.title.error, '拍照失败,请联系客服或尝试更换手机再试!');
                    }
                }
            }
        }
    }();

    var compressPicture = function (blob) {
        var quality = 0.5, image = new Image();
        image.src = blob;
        image.onload = function () {
            var that = this;
            // 生成比例
            var width = that.width, height = that.height;
            width = width / 4;
            height = height / 4;
            // 生成canvas画板
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(that, 0, 0, width, height);
            // 生成base64,兼容修复移动设备需要引入mobileBUGFix.js
            var imgurl = canvas.toDataURL('image/jpeg', quality);
            // 修复IOS兼容问题
            if (navigator.userAgent.match(/iphone/i)) {
                var mpImg = new MegaPixImage(image);
                mpImg.render(canvas, {
                    maxWidth: width,
                    maxHeight: height,
                    quality: quality
                });
                imgurl = canvas.toDataURL('image/jpeg', quality);
            }
            // 上传照片
            console.log(imgurl);
//            uploadPicture(imgurl);
            $('.demo-container').html('<img class="fa-img" id="img" src="' + imgurl + '" imgUrl="" alt="">');
        };
    };


    function tryIt() {
        $('#img').faceDetection({
            complete: function (faces) {
                console.log(faces);
                if(faces[0] == '' || faces[0] == null){
                    console.log('错误');
                }else{
                    console.log('有了');
                }
                for (var i = 0; i < faces.length; i++) {
                    $('<div>', {
                        'class':'face',
                        'css': {
                            'position': 'absolute',
                            'left':     faces[i].x * faces[i].scaleX + 'px',
                            'top':      faces[i].y * faces[i].scaleY + 'px',
                            'width':    faces[i].width  * faces[i].scaleX + 'px',
                            'height':   faces[i].height * faces[i].scaleY + 'px'
                        }
                    })
                        .insertAfter(this);
                }
            },
            error:function (code, message) {
                alert('Error: ' + message);
            }
        });
    }


    function shibie() {
        var fd;
        fd = new FormData();
        fd.append('image','../img/faces.jpeg')
        $.ajax({
            url: 'http://cloud.ai.360.cn:8000/rest/1.0/image/face-detection/detect',
//            url: fd,
            type: 'POST',
//            datatype: {image:[""]} ,
            data: fd,
            headers: {
                Accept: "application/json; charset=utf-8"
            },
//          headers : {"Authorization": "Basic QWxhZGRpbjpPcGVuU2VzYW1l"},
            cache: false,
            traditional: true,
            contentType: false,
            processData: false,
            success: function (data) {

            },
            error: function () {
            }
        });
    }

</script>